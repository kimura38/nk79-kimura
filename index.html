<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>2Dアクションゲーム</title>
<style>
body { margin:0; background:black; }
canvas { display:block; margin:auto; background:#5c94fc; }
</style>
</head>
<body>

<canvas id="game" width="480" height="270"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

//================ 状態 ================
let scene = "title"; // title, settings, game, pause
let language = localStorage.getItem("lang") || "jp";
let control  = localStorage.getItem("control") || "button";

//================ テキスト ================
const TEXT = {
 jp:{
  title:"2Dアクションゲーム",
  play:"プレイ",
  settings:"設定",
  language:"言語",
  control:"操作方法",
  button:"ボタン",
  keyboard:"キーボード",
  back:"もどる",
  resume:"再開",
  retry:"やり直し",
  toTitle:"タイトルへ"
 },
 en:{
  title:"2D Action Game",
  play:"PLAY",
  settings:"SETTINGS",
  language:"LANGUAGE",
  control:"CONTROL",
  button:"BUTTON",
  keyboard:"KEYBOARD",
  back:"BACK",
  resume:"RESUME",
  retry:"RETRY",
  toTitle:"TITLE"
 }
};

//================ プレイヤー ================
const player = { x:50,y:0,w:24,h:24,vx:0,vy:0,onGround:false };

const platforms = [
 {x:0,y:240,w:480,h:30},
 {x:150,y:180,w:80,h:10},
 {x:300,y:140,w:80,h:10}
];

const GRAVITY=0.6, SPEED=3, JUMP=-10;

//================ セーブ ================
function save(){
 localStorage.setItem("lang",language);
 localStorage.setItem("control",control);
}

//================ キーボード ================
const keys={};
document.addEventListener("keydown",e=>keys[e.key]=true);
document.addEventListener("keyup",e=>keys[e.key]=false);

//================ タッチ ================
canvas.addEventListener("touchstart",e=>{
 const r=canvas.getBoundingClientRect();
 const x=e.touches[0].clientX-r.left;
 const y=e.touches[0].clientY-r.top;

 if(scene==="title"){
  if(x>420 && y<40) scene="settings";
  else if(y>150 && y<190){ reset(); scene="game"; }
  return;
 }

 if(scene==="settings"){
  if(y>90 && y<120) language=language==="jp"?"en":"jp";
  if(y>130 && y<160) control=control==="button"?"keyboard":"button";
  if(y>200){ save(); scene="title"; }
  return;
 }

 if(scene==="pause"){
  if(y>90 && y<120) scene="game";
  if(y>130 && y<160){ reset(); scene="game"; }
  if(y>170 && y<200) scene="title";
  return;
 }

 if(scene==="game"){
  if(x>430 && y<40){ scene="pause"; return; }

  if(control==="button"){
   // 左
   if(x<120 && y>200) player.vx=-SPEED;
   // 右
   if(x>120 && x<240 && y>200) player.vx=SPEED;
   // ジャンプ
   if(x>360 && y>200 && player.onGround) player.vy=JUMP;
  }
 }
});

canvas.addEventListener("touchend",()=>{
 if(scene==="game" && control==="button"){
  player.vx=0;
 }
});

//================ 処理 ================
function reset(){
 player.x=50; player.y=0;
 player.vx=0; player.vy=0;
}

function hit(a,b){
 return a.x<b.x+b.w && a.x+a.w>b.x &&
        a.y<b.y+b.h && a.y+a.h>b.y;
}

function update(){
 if(scene!=="game") return;

 if(control==="keyboard"){
  if(keys["ArrowLeft"]) player.vx=-SPEED;
  else if(keys["ArrowRight"]) player.vx=SPEED;
  else player.vx=0;
  if(keys[" "] && player.onGround) player.vy=JUMP;
 }

 player.vy+=GRAVITY;
 player.x+=player.vx;
 player.y+=player.vy;
 player.onGround=false;

 platforms.forEach(p=>{
  if(hit(player,p)&&player.vy>0){
   player.y=p.y-player.h;
   player.vy=0;
   player.onGround=true;
  }
 });

 if(player.y>canvas.height) reset();
}

//================ 描画 ================
function drawButton(x,y,w,h,text){
 ctx.fillStyle="rgba(0,0,0,0.4)";
 ctx.fillRect(x,y,w,h);
 ctx.strokeStyle="white";
 ctx.strokeRect(x,y,w,h);
 ctx.fillStyle="white";
 ctx.font="16px sans-serif";
 ctx.fillText(text,x+w/2-8,y+h/2+6);
}

function draw(){
 ctx.clearRect(0,0,480,270);
 const T=TEXT[language];

 if(scene==="title"){
  ctx.fillStyle="white";
  ctx.font="26px sans-serif";
  ctx.fillText(T.title,90,120);
  ctx.font="20px sans-serif";
  ctx.fillText(T.play,210,170);
  drawButton(430,10,40,25,"⚙");
  return;
 }

 if(scene==="settings"){
  ctx.fillStyle="white";
  ctx.font="20px sans-serif";
  ctx.fillText(T.settings,200,40);
  ctx.font="16px sans-serif";
  ctx.fillText(T.language+": "+(language==="jp"?"日本語":"English"),120,110);
  ctx.fillText(T.control+": "+(control==="button"?T.button:T.keyboard),120,150);
  ctx.fillText("← "+T.back,200,220);
  return;
 }

 if(scene==="pause"){
  ctx.fillStyle="rgba(0,0,0,0.6)";
  ctx.fillRect(0,0,480,270);
  ctx.fillStyle="white";
  ctx.font="18px sans-serif";
  ctx.fillText(T.resume,210,110);
  ctx.fillText(T.retry,210,150);
  ctx.fillText(T.toTitle,190,190);
  return;
 }

 // ゲーム
 ctx.fillStyle="#654321";
 platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));
 ctx.fillStyle="red";
 ctx.fillRect(player.x,player.y,player.w,player.h);

 // ポーズ
 drawButton(430,10,40,25,"Ⅱ");

 // 操作ボタン
 if(control==="button"){
  drawButton(20,210,40,40,"◀");
  drawButton(70,210,40,40,"▶");
  drawButton(400,210,50,40,"⬆");
 }
}

//================ ループ ================
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
