<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<style>
body { margin:0; font-family:sans-serif; background:#111; color:#fff; }
header { display:flex; justify-content:space-between; padding:10px; background:#222; }
button { background:#0a84ff; color:#fff; border:none; padding:6px 10px; border-radius:6px; }
.hidden { display:none; }
#chatList div { padding:10px; border-bottom:1px solid #333; cursor:pointer; }
#messages { height:60vh; overflow:auto; padding:10px; }
.msg { margin:5px 0; }
.me { text-align:right; }
.modal { position:fixed; inset:0; background:rgba(0,0,0,.8); padding:20px; }
</style>
</head>
<body>

<header>
  <button onclick="openUser()">☰</button>
  <div id="title">トーク</div>
  <button onclick="openSelector()">＋</button>
</header>

<!-- トーク一覧 -->
<div id="chatList"></div>

<!-- チャット画面 -->
<div id="chat" class="hidden">
  <div id="messages"></div>
  <input id="text" placeholder="メッセージ">
  <button onclick="send()">送信</button>
</div>

<!-- ユーザー設定 -->
<div id="user" class="modal hidden">
  <h3>ユーザー</h3>
  <div>名前：<input id="myName"></div>
  <div>コード：<span id="myCode"></span></div>
  <input id="friendCode" placeholder="フレンドコード">
  <button onclick="addFriend()">追加</button>
  <br><br>
  <button onclick="resetAll()">初期化</button>
  <button onclick="closeAll()">閉じる</button>
</div>

<!-- フレンド選択 -->
<div id="selector" class="modal hidden">
  <h3>トーク開始</h3>
  <div id="friendList"></div>
  <button onclick="createChat()">追加</button>
  <button onclick="closeAll()">キャンセル</button>
</div>

<!-- グループ名変更 -->
<div id="groupEdit" class="modal hidden">
  <h3>グループ名変更</h3>
  <input id="groupName">
  <button onclick="saveGroupName()">保存</button>
  <button onclick="closeAll()">閉じる</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
 getDatabase, ref, set, get, push,
 onChildAdded, off, update
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
 apiKey: "AIzaSyCQNNj6Ff39wECAI6i8n1f2NXstF2k7duo",
 authDomain: "chat-99077.firebaseapp.com",
 databaseURL: "https://chat-99077-default-rtdb.firebaseio.com",
 projectId: "chat-99077"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let myUid = localStorage.uid || (localStorage.uid = crypto.randomUUID());
let currentChat = null;
let msgListener = null;
let friends = {};
let chats = {};

document.getElementById("myCode").textContent = myUid;

function openUser(){ user.classList.remove("hidden"); }
function openSelector(){ loadFriends(); selector.classList.remove("hidden"); }
function closeAll(){
 document.querySelectorAll(".modal").forEach(m=>m.classList.add("hidden"));
}

window.addFriend = async ()=>{
 const code = friendCode.value;
 const snap = await get(ref(db,"users/"+code));
 if(!snap.exists()) return alert("存在しません");
 set(ref(db,`friends/${myUid}/${code}`),true);
};

window.loadFriends = async ()=>{
 friendList.innerHTML="";
 const snap = await get(ref(db,"friends/"+myUid));
 if(!snap.exists()) return;
 friends = snap.val();
 for(const uid in friends){
   const u = await get(ref(db,"users/"+uid));
   const name = u.val()?.name || uid;
   friendList.innerHTML+=`
    <label><input type="checkbox" value="${uid}">${name}</label><br>`;
 }
};

window.createChat = ()=>{
 const checked=[...friendList.querySelectorAll("input:checked")].map(i=>i.value);
 if(checked.length===1){
   const id=[myUid,checked[0]].sort().join("_");
   set(ref(db,"chats/"+id),{type:"private",members:{[myUid]:1,[checked[0]]:1}});
   openChat(id);
 }else{
   const r=push(ref(db,"chats"));
   const m={}; m[myUid]=1; checked.forEach(u=>m[u]=1);
   set(r,{type:"group",name:"グループ",members:m});
   openChat(r.key);
 }
 closeAll();
};

function openChat(id){
 chat.classList.remove("hidden");
 chatList.classList.add("hidden");
 messages.innerHTML="";
 if(msgListener) off(msgListener);
 currentChat=id;
 const r=ref(db,"messages/"+id);
 msgListener=onChildAdded(r,s=>{
   const m=s.val();
   messages.innerHTML+=`<div class="msg ${m.sender===myUid?"me":""}">
   <b>${m.name}</b>: ${m.text}</div>`;
   update(ref(db,`messages/${id}/${s.key}/readBy/${myUid}`),true);
 });
}

window.send=()=>{
 const text=document.getElementById("text").value;
 if(!text) return;
 const id=push(ref(db,"messages/"+currentChat)).key;
 set(ref(db,`messages/${currentChat}/${id}`),{
   text,
   sender:myUid,
   name:myName.value,
   readBy:{[myUid]:true},
   time:Date.now()
 });
 document.getElementById("text").value="";
};

window.saveGroupName=()=>{
 update(ref(db,"chats/"+currentChat),{name:groupName.value});
 closeAll();
};

window.resetAll=()=>{
 localStorage.clear();
 location.reload();
};

set(ref(db,"users/"+myUid),{name:myName.value||"名無し"});
</script>
</body>
</html>
