<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>2Dアクション</title>
<style>
body{margin:0;background:black;}
canvas{
 display:block;
 margin:auto;
 background:#5c94fc;
 touch-action:none;
}
</style>
</head>
<body>

<canvas id="game" width="480" height="270"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

//================ 状態 =================
let scene="title"; // title settings game pause goal
let language="jp";
let control="button";
let touches=[];
let keys={};

//================ テキスト =================
const TEXT={
 jp:{
  title:"2Dアクションゲーム",
  play:"プレイ",
  back:"戻る",
  goal:"ゴール！",
  totitle:"タイトルに戻る",
  lang:"言語",
  control:"操作方法"
 }
};

//================ プレイヤー =================
const player={x:50,y:0,w:24,h:24,vx:0,vy:0,onGround:false};
let cameraX=0;

//================ ステージ =================
const platforms=[
 {x:0,y:240,w:1600,h:30},
 {x:200,y:190,w:80,h:10},
 {x:400,y:160,w:80,h:10}
];

// ゴール旗
const goalObj={
 pole:{x:1400,y:140,w:6,h:100},
 flag:{x:1406,y:140,w:20,h:15}
};

const GRAVITY=0.6,SPEED=3,JUMP=-10;

//================ 入力 =================
function updateTouches(e){
 const r=canvas.getBoundingClientRect();
 touches=[...e.touches].map(t=>({x:t.clientX-r.left,y:t.clientY-r.top}));
}
canvas.addEventListener("touchstart",e=>{
 updateTouches(e);

 if(scene==="title"){
  if(hitBox(140,160,200,40)){ reset(); scene="game"; }
  if(hitBox(430,10,40,25)) scene="settings";
 }
});
canvas.addEventListener("touchmove",updateTouches);
canvas.addEventListener("touchend",updateTouches);

window.addEventListener("keydown",e=>keys[e.key]=true);
window.addEventListener("keyup",e=>keys[e.key]=false);

//================ 判定 =================
function hit(a,b){
 return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
}
function hitBox(x,y,w,h){
 return touches.some(t=>t.x>=x&&t.x<=x+w&&t.y>=y&&t.y<=y+h);
}

//================ リセット =================
function reset(){
 player.x=50;player.y=0;
 player.vx=0;player.vy=0;
 cameraX=0;
}

//================ 更新 =================
function update(){
 if(scene!=="game") return;

 // ボタン操作
 if(control==="button"){
  if(hitBox(20,210,40,40)) player.vx=-SPEED;
  else if(hitBox(70,210,40,40)) player.vx=SPEED;
  else player.vx=0;

  if(hitBox(400,210,50,40)&&player.onGround){
   player.vy=JUMP;
  }
 }

 // キーボード操作
 if(control==="keyboard"){
  if(keys["ArrowLeft"]||keys["a"]) player.vx=-SPEED;
  else if(keys["ArrowRight"]||keys["d"]) player.vx=SPEED;
  else player.vx=0;

  if(keys["Enter"]&&player.onGround){
   player.vy=JUMP;
  }
 }

 // 一時停止
 if(hitBox(430,10,40,25)) scene="pause";

 // 物理
 player.vy+=GRAVITY;
 player.x+=player.vx;
 player.y+=player.vy;
 player.onGround=false;

 platforms.forEach(p=>{
  if(hit(player,p)&&player.vy>0){
   player.y=p.y-player.h;
   player.vy=0;
   player.onGround=true;
  }
 });

 // ゴール判定
 if(hit(player,goalObj.pole)||hit(player,goalObj.flag)){
  scene="goal";
 }

 cameraX=Math.max(0,player.x-200);
}

//================ 描画 =================
function drawButton(x,y,w,h,text){
 ctx.fillStyle="#777";
 ctx.fillRect(x,y,w,h);
 ctx.strokeStyle="white";
 ctx.strokeRect(x,y,w,h);
 ctx.fillStyle="white";
 ctx.font="18px sans-serif";
 ctx.fillText(text,x+w/2-ctx.measureText(text).width/2,y+h/2+6);
}

function draw(){
 ctx.clearRect(0,0,480,270);
 const T=TEXT.jp;

 // タイトル
 if(scene==="title"){
  ctx.fillStyle="#5c94fc";
  ctx.fillRect(0,0,480,200);
  ctx.fillStyle="#228b22";
  ctx.fillRect(0,200,480,70);

  ctx.fillStyle="white";
  ctx.font="26px sans-serif";
  ctx.fillText(T.title,80,100);

  drawButton(140,160,200,40,T.play);
  drawButton(430,10,40,25,"⚙");
  return;
 }

 // 設定（枠なし）
 if(scene==="settings"){
  ctx.fillStyle="white";
  ctx.font="20px sans-serif";
  ctx.fillText("設定",200,40);

  ctx.font="16px sans-serif";
  ctx.fillText(`${T.lang} : ${language}`,140,80);
  ctx.fillText(`${T.control} : ${control}`,140,110);

  ctx.fillText("キーボード操作",140,150);
  ctx.fillText("← / A ：左移動",140,170);
  ctx.fillText("→ / D ：右移動",140,190);
  ctx.fillText("Enter ：ジャンプ",140,210);

  // タップ判定（文字範囲）
  if(hitBox(140,60,200,30)) language=language==="jp"?"en":"jp";
  if(hitBox(140,90,200,30)) control=control==="button"?"keyboard":"button";
  if(hitBox(140,230,200,30)) scene="title";

  ctx.fillText("← 戻る",140,230);
  return;
 }

 // ポーズ
 if(scene==="pause"){
  drawButton(140,80,200,40,"再開");
  drawButton(140,130,200,40,"やり直し");
  drawButton(140,180,200,40,"タイトルへ");

  if(hitBox(140,80,200,40)) scene="game";
  if(hitBox(140,130,200,40)){ reset(); scene="game"; }
  if(hitBox(140,180,200,40)) scene="title";
  return;
 }

 // ゴール
 if(scene==="goal"){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,480,270);
  ctx.fillStyle="white";
  ctx.font="30px sans-serif";
  ctx.fillText(T.goal,170,120);
  drawButton(140,170,200,40,T.totitle);

  if(hitBox(140,170,200,40)) scene="title";
  return;
 }

 // ゲーム
 ctx.save();
 ctx.translate(-cameraX,0);

 ctx.fillStyle="#654321";
 platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

 ctx.fillStyle="white";
 ctx.fillRect(goalObj.pole.x,goalObj.pole.y,goalObj.pole.w,goalObj.pole.h);
 ctx.fillStyle="red";
 ctx.fillRect(goalObj.flag.x,goalObj.flag.y,goalObj.flag.w,goalObj.flag.h);

 ctx.fillStyle="red";
 ctx.fillRect(player.x,player.y,player.w,player.h);

 ctx.restore();

 drawButton(430,10,40,25,"Ⅱ");
 drawButton(20,210,40,40,"◀");
 drawButton(70,210,40,40,"▶");
 drawButton(400,210,50,40,"⬆");
}

//================ ループ =================
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
