<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>2Dアクション</title>
<style>
body { margin:0; background:black; }
canvas {
  display:block;
  margin:auto;
  background:#5c94fc;
  touch-action:none;
}
</style>
</head>
<body>

<canvas id="game" width="480" height="270"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

//================ 状態 =================
let scene = "title"; // title game pause
let touches = [];

//================ プレイヤー =================
const player = { x:50,y:0,w:24,h:24,vx:0,vy:0,onGround:false };
let cameraX = 0;

//================ ステージ =================
const platforms = [
 {x:0,y:240,w:1600,h:30},
 {x:200,y:190,w:80,h:10},
 {x:400,y:160,w:80,h:10},
 {x:600,y:190,w:80,h:10}
];

// ゴール（旗）
const goal = {
 pole:{x:1500,y:140,w:6,h:100},
 flag:{x:1506,y:140,w:20,h:15}
};

const GRAVITY = 0.6;
const SPEED   = 3;
const JUMP    = -10;

//================ タッチ =================
function updateTouches(e){
 const r = canvas.getBoundingClientRect();
 touches = [...e.touches].map(t=>({
  x: t.clientX - r.left,
  y: t.clientY - r.top
 }));
}
canvas.addEventListener("touchstart",e=>{
 updateTouches(e);

 // タイトル → ゲーム
 if(scene==="title" && hitBox(140,170,200,40)){
  reset();
  scene="game";
 }
});
canvas.addEventListener("touchmove",updateTouches);
canvas.addEventListener("touchend",updateTouches);

//================ 判定 =================
function hit(a,b){
 return a.x<b.x+b.w && a.x+a.w>b.x &&
        a.y<b.y+b.h && a.y+a.h>b.y;
}
function hitBox(x,y,w,h){
 return touches.some(t=>t.x>=x&&t.x<=x+w&&t.y>=y&&t.y<=y+h);
}

//================ リセット =================
function reset(){
 player.x=50; player.y=0;
 player.vx=0; player.vy=0;
 cameraX=0;
}

//================ 更新 =================
function update(){
 if(scene!=="game") return;

 // 移動（元の配置）
 if(hitBox(20,210,40,40))      player.vx = -SPEED; // ◀
 else if(hitBox(70,210,40,40)) player.vx =  SPEED; // ▶
 else                          player.vx = 0;

 // ジャンプ（⬆・同時押しOK）
 if(hitBox(400,210,50,40) && player.onGround){
  player.vy = JUMP;
 }

 // ポーズ
 if(hitBox(430,10,40,25)){
  scene = "pause";
 }

 player.vy += GRAVITY;
 player.x  += player.vx;
 player.y  += player.vy;
 player.onGround = false;

 platforms.forEach(p=>{
  if(hit(player,p) && player.vy>0){
   player.y = p.y - player.h;
   player.vy = 0;
   player.onGround = true;
  }
 });

 // ゴール（先に進めない）
 if(hit(player,goal.pole) || hit(player,goal.flag)){
  player.x = goal.pole.x - player.w;
 }

 cameraX = Math.max(0, player.x - 200);
}

//================ 描画 =================
function drawButton(x,y,w,h,text){
 ctx.fillStyle="#555";
 ctx.fillRect(x,y,w,h);
 ctx.strokeStyle="white";
 ctx.strokeRect(x,y,w,h);
 ctx.fillStyle="white";
 ctx.font="18px sans-serif";
 ctx.fillText(text,x+w/2-ctx.measureText(text).width/2,y+h/2+6);
}

function draw(){
 ctx.clearRect(0,0,480,270);

 // タイトル
 if(scene==="title"){
  ctx.fillStyle="#5c94fc";
  ctx.fillRect(0,0,480,200);
  ctx.fillStyle="#228b22";
  ctx.fillRect(0,200,480,70);
  ctx.fillStyle="white";
  ctx.font="28px sans-serif";
  ctx.fillText("2Dアクションゲーム",60,100);
  drawButton(140,170,200,40,"プレイ");
  return;
 }

 // ポーズ
 if(scene==="pause"){
  ctx.fillStyle="rgba(0,0,0,0.6)";
  ctx.fillRect(0,0,480,270);
  drawButton(140,80,200,40,"再開");
  drawButton(140,130,200,40,"やり直し");
  drawButton(140,180,200,40,"タイトル");

  // 再開
  if(hitBox(140,80,200,40)) scene="game";
  if(hitBox(140,130,200,40)) { reset(); scene="game"; }
  if(hitBox(140,180,200,40)) scene="title";
  return;
 }

 // ゲーム描画
 ctx.save();
 ctx.translate(-cameraX,0);

 ctx.fillStyle="#654321";
 platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

 // ゴール旗
 ctx.fillStyle="white";
 ctx.fillRect(goal.pole.x,goal.pole.y,goal.pole.w,goal.pole.h);
 ctx.fillStyle="red";
 ctx.fillRect(goal.flag.x,goal.flag.y,goal.flag.w,goal.flag.h);

 ctx.fillStyle="red";
 ctx.fillRect(player.x,player.y,player.w,player.h);

 ctx.restore();

 // UI（元の見た目）
 drawButton(430,10,40,25,"⚙");
 drawButton(380,10,40,25,"Ⅱ");

 drawButton(20,210,40,40,"◀");
 drawButton(70,210,40,40,"▶");
 drawButton(400,210,50,40,"⬆");
}

//================ ループ =================
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
