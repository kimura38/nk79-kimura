<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>

<style>
html,body{
  margin:0;padding:0;height:100%;overflow:hidden;
  font-family:system-ui,sans-serif;background:#f2f2f2;
}
.screen{position:absolute;inset:0;display:none;flex-direction:column}
.screen.active{display:flex}
header{
  height:50px;background:#06c755;color:#fff;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;flex-shrink:0
}
.list{flex:1;overflow-y:auto}
.item{background:#fff;padding:14px;border-bottom:1px solid #ddd}
.center{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center}
.chat{flex:1;overflow-y:auto;padding:10px}
.msg{max-width:70%;padding:8px;border-radius:10px;margin:6px}
.me{background:#06c755;color:#fff;margin-left:auto}
.other{background:#ddd}
.input{display:flex;padding:6px;background:#fff}
input{flex:1;padding:8px;font-size:16px}
button{padding:8px 12px;font-size:14px;border:none;border-radius:6px}
.green{background:#06c755;color:#fff}
.gray{background:#ccc}
</style>
</head>

<body>

<!-- 初期設定 -->
<div id="setup" class="screen">
  <header>初期設定</header>
  <div class="center">
    <input id="nameInput" placeholder="名前">
    <button class="green" onclick="saveUser()">開始</button>
  </div>
</div>

<!-- トーク一覧 -->
<div id="home" class="screen">
  <header>
    <span onclick="openUser()">☰</span>
    トーク
    <span onclick="createChat()">＋</span>
  </header>
  <div id="chatList" class="list"></div>
</div>

<!-- チャット -->
<div id="chatScreen" class="screen">
  <header>
    <span onclick="backHome()">←</span>
    <span id="chatTitle">チャット</span>
  </header>
  <div id="messages" class="chat"></div>
  <div class="input">
    <input id="msgInput">
    <button class="green" onclick="sendMsg()">送信</button>
  </div>
</div>

<!-- ユーザー -->
<div id="userScreen" class="screen">
  <header>
    <span onclick="backHome()">←</span>
    ユーザー
  </header>
  <div style="padding:15px">
    <div id="userInfo"></div><br>
    <input id="newName" placeholder="名前変更">
    <button onclick="changeName()">変更</button><br><br>

    <b>フレンドコード</b>
    <div id="myCode"></div><br>

    <input id="addCode" placeholder="コード入力">
    <button onclick="addFriend()">フレンド追加</button><br><br>

    <button class="gray" onclick="resetAll()">初期化（削除）</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQNNj6Ff39wECAI6i8n1f2NXstF2k7duo",
  authDomain: "chat-99077.firebaseapp.com",
  databaseURL: "https://chat-99077-default-rtdb.firebaseio.com",
  projectId: "chat-99077"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let userId = localStorage.getItem("uid");
let userName = localStorage.getItem("name");
let code = localStorage.getItem("code");
let currentChat = null;

function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

if(userId) loadHome();
else show("setup");

window.saveUser=()=>{
  const name=nameInput.value.trim();
  if(!name) return alert("名前を入力");
  userId=crypto.randomUUID();
  code=Math.random().toString(36).slice(2,7).toUpperCase();
  localStorage.setItem("uid",userId);
  localStorage.setItem("name",name);
  localStorage.setItem("code",code);
  set(ref(db,"users/"+userId),{name,code,chats:{}});
  loadHome();
};

function loadHome(){
  show("home");
  chatList.innerHTML="";
  onValue(ref(db,"users/"+userId+"/chats"),snap=>{
    chatList.innerHTML="";
    snap.forEach(c=>{
      const d=document.createElement("div");
      d.className="item";
      d.textContent=c.key;
      d.onclick=()=>openChat(c.key);
      chatList.appendChild(d);
    });
  });
}

window.createChat=async()=>{
  const c=prompt("1:1対1 / 2:グループ");
  if(!c) return;
  if(c==="1"){
    const f=prompt("相手のコード");
    const us=await get(ref(db,"users"));
    let target=null;
    us.forEach(u=>{if(u.val().code===f) target=u.key});
    if(!target) return alert("見つからない");
    const id="chat_"+Date.now();
    set(ref(db,"chats/"+id),{members:{[userId]:1,[target]:1},messages:{}});
    set(ref(db,"users/"+userId+"/chats/"+id),1);
    set(ref(db,"users/"+target+"/chats/"+id),1);
  } else {
    alert("グループは次対応");
  }
};

function openChat(id){
  currentChat=id;
  show("chatScreen");
  messages.innerHTML="";
  onValue(ref(db,"chats/"+id+"/messages"),snap=>{
    messages.innerHTML="";
    snap.forEach(m=>{
      const d=document.createElement("div");
      d.className="msg "+(m.val().sender===userId?"me":"other");
      d.textContent=m.val().text;
      messages.appendChild(d);
      messages.scrollTop=messages.scrollHeight;
    });
  });
}

window.sendMsg=()=>{
  if(!msgInput.value) return;
  push(ref(db,"chats/"+currentChat+"/messages"),{
    sender:userId,text:msgInput.value,time:Date.now()
  });
  msgInput.value="";
};

window.openUser=()=>{
  show("userScreen");
  userInfo.textContent="名前: "+localStorage.getItem("name");
  myCode.textContent=localStorage.getItem("code");
};

window.changeName=()=>{
  const n=newName.value.trim();
  if(!n) return;
  set(ref(db,"users/"+userId+"/name"),n);
  localStorage.setItem("name",n);
  alert("変更完了");
};

window.addFriend=()=>alert("1対1作成で自動登録");
window.resetAll=()=>{
  if(confirm("削除する？")){
    localStorage.clear();
    location.reload();
  }
};
window.backHome=()=>loadHome();
</script>

</body>
</html>
