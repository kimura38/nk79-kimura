<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Simple Chat</title>

<style>
body { margin:0; font-family:sans-serif; background:#f5f5f5; }
header { height:50px; background:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 10px; border-bottom:1px solid #ccc; }
button { padding:6px 10px; }
#home, #chat, #profile { display:none; }
.list { padding:10px; }
.item { background:#fff; padding:10px; margin-bottom:8px; border-radius:6px; cursor:pointer; }
.badge { background:red; color:white; border-radius:10px; font-size:10px; padding:2px 6px; margin-left:6px; }

#messages { padding:10px; height:calc(100vh - 140px); overflow-y:auto; }
.msg { margin-bottom:6px; max-width:70%; padding:6px 8px; border-radius:6px; }
.me { background:#dcf8c6; margin-left:auto; }
.other { background:#fff; }
.read { font-size:10px; color:#888; text-align:right; }

footer { display:flex; padding:8px; background:#fff; }
footer input { flex:1; padding:6px; }
</style>
</head>

<body>

<header>
  <button onclick="openProfile()">☰</button>
  <div id="title">Chat</div>
  <button onclick="openFriendPicker()">＋</button>
</header>

<!-- ホーム -->
<div id="home" class="list"></div>

<!-- チャット -->
<div id="chat">
  <div id="messages"></div>
  <footer>
    <input id="msgInput" placeholder="メッセージ"/>
    <button id="sendBtn">送信</button>
  </footer>
</div>

<!-- プロフィール -->
<div id="profile" class="list">
  <div class="item">名前: <span id="myName"></span></div>
  <div class="item">コード: <span id="myCode"></span></div>
  <input id="friendCode" placeholder="フレンドコード"/>
  <button onclick="addFriend()">フレンド追加</button>
  <button onclick="closeProfile()">戻る</button>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getDatabase, ref, set, get, push, onValue, update
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCQNNj6Ff39wECAI6i8n1f2NXstF2k7duo",
  authDomain: "chat-99077.firebaseapp.com",
  databaseURL: "https://chat-99077-default-rtdb.firebaseio.com",
  projectId: "chat-99077"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===== 初期設定 ===== */
let userId = localStorage.getItem("uid");
let userName = localStorage.getItem("name");

if (!userId) {
  userId = "u_" + Date.now();
  userName = prompt("名前を入力") || "名無し";
  localStorage.setItem("uid", userId);
  localStorage.setItem("name", userName);

  const code = Math.random().toString(36).slice(2, 7).toUpperCase();
  set(ref(db, "users/" + userId), {
    name: userName,
    code: code
  });
}

const userSnap = await get(ref(db, "users/" + userId));
const myCode = userSnap.val().code;

myName.textContent = userName;
myCode.textContent = myCode;

/* ===== 画面制御 ===== */
const home = document.getElementById("home");
const chat = document.getElementById("chat");
const profile = document.getElementById("profile");

function show(el) {
  home.style.display = "none";
  chat.style.display = "none";
  profile.style.display = "none";
  el.style.display = "block";
}

show(home);

/* ===== フレンド追加 ===== */
window.addFriend = async () => {
  const code = friendCode.value.trim().toUpperCase();
  const snap = await get(ref(db, "users"));

  let target = null;
  snap.forEach(u => {
    if (u.val().code === code) target = u.key;
  });

  if (!target) return alert("見つかりません");

  set(ref(db, `users/${userId}/friends/${target}`), true);
  set(ref(db, `users/${target}/friends/${userId}`), true);
  alert("フレンド追加完了");
};

/* ===== トーク一覧 ===== */
async function loadHome() {
  home.innerHTML = "";
  const chatsSnap = await get(ref(db, `users/${userId}/chats`));
  if (!chatsSnap.exists()) return;

  for (const cid in chatsSnap.val()) {
    const chatSnap = await get(ref(db, "chats/" + cid));
    const members = chatSnap.val().members;
    const otherId = Object.keys(members).find(id => id !== userId);
    const other = await get(ref(db, "users/" + otherId));

    let unread = 0;
    const msgs = chatSnap.val().messages || {};
    for (const mid in msgs) {
      const m = msgs[mid];
      if (m.sender !== userId && (!m.readBy || !m.readBy[userId])) unread++;
    }

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = other.val().name + (unread ? `<span class="badge">${unread}</span>` : "");
    div.onclick = () => openChat(cid, other.val().name);
    home.appendChild(div);
  }
}
loadHome();

/* ===== フレンド一覧 → チャット開始 ===== */
window.openFriendPicker = async () => {
  const snap = await get(ref(db, `users/${userId}/friends`));
  if (!snap.exists()) return alert("フレンドなし");

  let names = [];
  for (const fid in snap.val()) {
    const u = await get(ref(db, "users/" + fid));
    names.push({ id: fid, name: u.val().name });
  }

  const name = prompt("誰と話す？\n" + names.map(n => n.name).join("\n"));
  const target = names.find(n => n.name === name);
  if (!target) return;

  startChat(target.id, target.name);
};

async function startChat(targetId, targetName) {
  const snap = await get(ref(db, `users/${userId}/chats`));
  let cid = null;

  if (snap.exists()) {
    for (const id in snap.val()) {
      const m = await get(ref(db, `chats/${id}/members`));
      if (m.val()[targetId]) cid = id;
    }
  }

  if (!cid) {
    cid = "chat_" + Date.now();
    set(ref(db, "chats/" + cid), {
      members: { [userId]: true, [targetId]: true }
    });
    set(ref(db, `users/${userId}/chats/${cid}`), true);
    set(ref(db, `users/${targetId}/chats/${cid}`), true);
  }

  openChat(cid, targetName);
}

/* ===== チャット ===== */
let currentChat = null;
const messages = document.getElementById("messages");

function openChat(cid, name) {
  currentChat = cid;
  title.textContent = name;
  show(chat);

  onValue(ref(db, `chats/${cid}/messages`), snap => {
    messages.innerHTML = "";
    snap?.forEach(m => {
      const d = m.val();

      if (d.sender !== userId && (!d.readBy || !d.readBy[userId])) {
        update(ref(db, `chats/${cid}/messages/${m.key}/readBy`), {
          [userId]: true
        });
      }

      const div = document.createElement("div");
      div.className = "msg " + (d.sender === userId ? "me" : "other");
      div.innerHTML = d.sender === userId
        ? `${d.text}<div class="read">${d.readBy && Object.keys(d.readBy).length > 1 ? "既読" : "未読"}</div>`
        : d.text;

      messages.appendChild(div);
    });
    messages.scrollTop = messages.scrollHeight;
  });

  loadHome();
}

sendBtn.onclick = () => {
  if (!msgInput.value) return;
  const msgRef = push(ref(db, `chats/${currentChat}/messages`));
  set(msgRef, {
    sender: userId,
    text: msgInput.value,
    time: Date.now(),
    readBy: { [userId]: true }
  });
  msgInput.value = "";
};

/* ===== プロフィール ===== */
window.openProfile = () => show(profile);
window.closeProfile = () => show(home);
</script>
</body>
</html>
