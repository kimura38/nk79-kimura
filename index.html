<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>2D Action Game</title>
<style>
body{margin:0;background:black;}
canvas{
 display:block;
 margin:auto;
 background:#5c94fc;
 touch-action:none;
}
</style>
</head>
<body>

<canvas id="game" width="480" height="270"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

//================ 状態 =================
let scene="title"; // title map settings game pause
let language="jp";
let control="button";
let currentStage=0;
let unlockedStage=1;

let pointers=[];
let pointerDown=false;
let pointerJustDown=false;
let keys={};

//================ テキスト =================
const TEXT={
 jp:{
  title:"2Dアクションゲーム",
  play:"プレイ",
  map:"ステージ選択",
  stage:"ステージ",
  back:"戻る",
  resume:"再開",
  retry:"やり直し",
  tomap:"マップへ"
 },
 en:{
  title:"2D Action Game",
  play:"Play",
  map:"Stage Select",
  stage:"Stage",
  back:"Back",
  resume:"Resume",
  retry:"Retry",
  tomap:"To Map"
 }
};

//================ プレイヤー =================
const player={x:50,y:0,w:24,h:24,vx:0,vy:0,onGround:false};
let cameraX=0;

//================ ステージデータ =================
const STAGES=[
 {goalX:800},
 {goalX:1000},
 {goalX:1200}
];

const platforms=[
 {x:0,y:240,w:1600,h:30},
 {x:200,y:190,w:80,h:10},
 {x:400,y:160,w:80,h:10}
];

const GRAVITY=0.6,SPEED=3,JUMP=-10;

//================ 入力 =================
function setPointer(e){
 const r=canvas.getBoundingClientRect();
 pointers=[{x:e.clientX-r.left,y:e.clientY-r.top}];
}
canvas.addEventListener("mousedown",e=>{
 setPointer(e);
 pointerDown=true;
 pointerJustDown=true;
});
window.addEventListener("mouseup",()=>{
 pointerDown=false;
 pointers=[];
});
canvas.addEventListener("touchstart",e=>{
 const r=canvas.getBoundingClientRect();
 pointers=[...e.touches].map(t=>({
  x:t.clientX-r.left,
  y:t.clientY-r.top
 }));
 pointerDown=true;
 pointerJustDown=true;
});
canvas.addEventListener("touchend",()=>{
 pointerDown=false;
 pointers=[];
});

window.addEventListener("keydown",e=>keys[e.key]=true);
window.addEventListener("keyup",e=>keys[e.key]=false);

//================ 判定 =================
function hitBox(x,y,w,h){
 return pointers.some(p=>p.x>=x&&p.x<=x+w&&p.y>=y&&p.y<=y+h);
}
function justPressed(x,y,w,h){
 return pointerJustDown && hitBox(x,y,w,h);
}

//================ リセット =================
function reset(){
 player.x=50;
 player.y=0;
 player.vx=0;
 player.vy=0;
 cameraX=0;
}

//================ 更新 =================
function update(){
 // -------- タイトル --------
 if(scene==="title"){
  if(justPressed(140,160,200,40)) scene="map";
 }

 // -------- マップ --------
 if(scene==="map"){
  for(let i=0;i<STAGES.length;i++){
   if(i<unlockedStage){
    if(justPressed(140,80+i*40,200,30)){
     currentStage=i;
     reset();
     scene="game";
    }
   }
  }
  if(justPressed(20,230,80,30)) scene="title";
 }

 // -------- ゲーム --------
 if(scene==="game"){
  // 移動（ジャンプと分離）
  if(control==="button"){
   if(hitBox(20,210,40,40)) player.vx=-SPEED;
   else if(hitBox(70,210,40,40)) player.vx=SPEED;
   else player.vx=0;

   if(hitBox(400,210,50,40)&&player.onGround){
    player.vy=JUMP;
   }
  }

  if(control==="keyboard"){
   if(keys["ArrowLeft"]||keys["a"]) player.vx=-SPEED;
   else if(keys["ArrowRight"]||keys["d"]) player.vx=SPEED;
   else player.vx=0;

   if(keys["Enter"]&&player.onGround){
    player.vy=JUMP;
   }
  }

  // 物理
  player.vy+=GRAVITY;
  player.x+=player.vx;
  player.y+=player.vy;
  player.onGround=false;

  platforms.forEach(p=>{
   if(player.x<p.x+p.w&&player.x+player.w>p.x&&
      player.y<p.y+p.h&&player.y+player.h>p.y&&player.vy>0){
    player.y=p.y-player.h;
    player.vy=0;
    player.onGround=true;
   }
  });

  // ゴール判定
  if(player.x > STAGES[currentStage].goalX){
   unlockedStage=Math.max(unlockedStage,currentStage+2);
   scene="map";
  }

  cameraX=Math.max(0,player.x-200);
 }

 pointerJustDown=false;
}

//================ 描画 =================
function drawButton(x,y,w,h,text,enabled=true){
 ctx.fillStyle=enabled?"#777":"#444";
 ctx.fillRect(x,y,w,h);
 ctx.strokeStyle="white";
 ctx.strokeRect(x,y,w,h);
 ctx.fillStyle="white";
 ctx.font="16px sans-serif";
 ctx.fillText(text,x+w/2-ctx.measureText(text).width/2,y+h/2+6);
}

function draw(){
 ctx.clearRect(0,0,480,270);
 const T=TEXT[language];

 if(scene==="title"){
  ctx.fillStyle="#5c94fc";
  ctx.fillRect(0,0,480,270);
  ctx.fillStyle="white";
  ctx.font="26px sans-serif";
  ctx.fillText(T.title,80,100);
  drawButton(140,160,200,40,T.play);
  return;
 }

 if(scene==="map"){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,480,270);
  ctx.fillStyle="white";
  ctx.font="22px sans-serif";
  ctx.fillText(T.map,150,40);

  ctx.font="16px sans-serif";
  for(let i=0;i<STAGES.length;i++){
   const unlocked=i<unlockedStage;
   drawButton(
    140,80+i*40,200,30,
    `${T.stage} ${i+1}`,
    unlocked
   );
  }
  drawButton(20,230,80,30,T.back);
  return;
 }

 // -------- ゲーム描画 --------
 ctx.save();
 ctx.translate(-cameraX,0);

 ctx.fillStyle="#654321";
 platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

 ctx.fillStyle="yellow";
 ctx.fillRect(STAGES[currentStage].goalX,200,20,40);

 ctx.fillStyle="red";
 ctx.fillRect(player.x,player.y,player.w,player.h);

 ctx.restore();

 // 操作ボタン（キーボード時は非表示）
 if(control==="button"){
  drawButton(20,210,40,40,"◀");
  drawButton(70,210,40,40,"▶");
  drawButton(400,210,50,40,"⬆");
 }
}

//================ ループ =================
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
