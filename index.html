<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Chat</title>

<style>
html,body{margin:0;height:100%;font-family:system-ui;background:#f2f2f2;overflow:hidden}
.screen{position:absolute;inset:0;display:none;flex-direction:column}
.screen.active{display:flex}
header{height:50px;background:#06c755;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 12px}
.list{flex:1;overflow-y:auto}
.item{background:#fff;padding:14px;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center}
.badge{background:red;color:#fff;border-radius:10px;font-size:11px;padding:2px 6px}
.center{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center}
.chat{flex:1;overflow-y:auto;padding:10px}
.msg{max-width:70%;padding:8px;border-radius:10px;margin:6px}
.me{background:#06c755;color:#fff;margin-left:auto}
.other{background:#ddd}
.read{font-size:10px;color:#eee;text-align:right}
.input{display:flex;padding:6px;background:#fff}
input{flex:1;padding:8px;font-size:16px}
button{padding:8px 12px;font-size:14px;border:none;border-radius:6px}
.green{background:#06c755;color:#fff}
.gray{background:#ccc}
</style>
</head>

<body>

<!-- 初期設定 -->
<div id="setup" class="screen">
<header>初期設定</header>
<div class="center">
<input id="nameInput" placeholder="名前">
<button class="green" onclick="saveUser()">開始</button>
</div>
</div>

<!-- トーク一覧 -->
<div id="home" class="screen">
<header>
<span onclick="openUser()">☰</span>
トーク
<span onclick="openFriendSelect()">＋</span>
</header>
<div id="chatList" class="list"></div>
</div>

<!-- フレンド選択 -->
<div id="friendSelect" class="screen">
<header>
<span onclick="backHome()">←</span>
トークを開始
</header>
<div id="friendList" class="list"></div>
</div>

<!-- チャット -->
<div id="chatScreen" class="screen">
<header>
<span onclick="backHome()">←</span>
<span id="chatTitle"></span>
</header>
<div id="messages" class="chat"></div>
<div class="input">
<input id="msgInput">
<button class="green" onclick="sendMsg()">送信</button>
</div>
</div>

<!-- ユーザー -->
<div id="userScreen" class="screen">
<header>
<span onclick="backHome()">←</span>ユーザー
</header>
<div style="padding:15px">
<div id="userInfo"></div><br>
<input id="newName" placeholder="名前変更">
<button onclick="changeName()">変更</button><br><br>

<b>フレンドコード</b>
<div id="myCode"></div><br>

<input id="addCode" placeholder="フレンドコード入力">
<button onclick="addFriend()">フレンド追加</button><br><br>

<button class="gray" onclick="resetAll()">初期化</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyCQNNj6Ff39wECAI6i8n1f2NXstF2k7duo",
databaseURL:"https://chat-99077-default-rtdb.firebaseio.com",
projectId:"chat-99077"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

let userId=localStorage.getItem("uid");
let currentChat=null;

const show=id=>{
document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
};

if(userId) loadHome(); else show("setup");

/* 初期設定 */
window.saveUser=()=>{
const name=nameInput.value.trim();
if(!name)return;
userId=crypto.randomUUID();
const code=Math.random().toString(36).slice(2,7).toUpperCase();
localStorage.setItem("uid",userId);
localStorage.setItem("name",name);
localStorage.setItem("code",code);
set(ref(db,"users/"+userId),{name,code,friends:{},chats:{}});
loadHome();
};

/* トーク一覧 */
async function loadHome(){
show("home");
onValue(ref(db,"users/"+userId+"/chats"),async snap=>{
chatList.innerHTML="";
for(const cid in snap.val()||{}){
const chat=await get(ref(db,"chats/"+cid));
const members=chat.val().members;
const otherId=Object.keys(members).find(id=>id!==userId);
const other=await get(ref(db,"users/"+otherId));

let unread=0;
for(const mid in chat.val().messages||{}){
const m=chat.val().messages[mid];
if(m.sender!==userId && (!m.readBy||!m.readBy[userId])) unread++;
}

const div=document.createElement("div");
div.className="item";
div.innerHTML=`${other.val().name}${unread?`<span class="badge">${unread}</span>`:""}`;
div.onclick=()=>openChat(cid,other.val().name);
chatList.appendChild(div);
}
});
}

/* ＋ フレンド選択（選択式） */
window.openFriendSelect=async()=>{
show("friendSelect");
friendList.innerHTML="";

const snap=await get(ref(db,"users/"+userId+"/friends"));
if(!snap.exists()){
friendList.innerHTML="<div class='item'>フレンドがいません</div>";
return;
}

for(const fid in snap.val()){
const u=await get(ref(db,"users/"+fid));
const div=document.createElement("div");
div.className="item";
div.textContent=u.val().name;
div.onclick=()=>startChat({id:fid,name:u.val().name});
friendList.appendChild(div);
}
};

/* チャット開始 */
async function startChat(friend){
const snap=await get(ref(db,"users/"+userId+"/chats"));
let cid=null;

if(snap.exists()){
for(const id in snap.val()){
const m=await get(ref(db,"chats/"+id+"/members"));
if(m.val()[friend.id]) cid=id;
}
}

if(!cid){
cid="chat_"+Date.now();
set(ref(db,"chats/"+cid),{members:{[userId]:true,[friend.id]:true}});
set(ref(db,"users/"+userId+"/chats/"+cid),true);
set(ref(db,"users/"+friend.id+"/chats/"+cid),true);
}

openChat(cid,friend.name);
}

/* チャット画面 */
function openChat(cid,name){
currentChat=cid;
chatTitle.textContent=name;
show("chatScreen");

onValue(ref(db,"chats/"+cid+"/messages"),snap=>{
messages.innerHTML="";
snap?.forEach(m=>{
const d=m.val();
if(d.sender!==userId && (!d.readBy||!d.readBy[userId])){
update(ref(db,`chats/${cid}/messages/${m.key}/readBy`),{[userId]:true});
}
const div=document.createElement("div");
div.className="msg "+(d.sender===userId?"me":"other");
div.innerHTML=d.sender===userId
?`${d.text}<div class="read">${d.readBy&&Object.keys(d.readBy).length>1?"既読":"未読"}</div>`
:d.text;
messages.appendChild(div);
messages.scrollTop=messages.scrollHeight;
});
});
}

/* 送信 */
window.sendMsg=()=>{
if(!msgInput.value)return;
push(ref(db,"chats/"+currentChat+"/messages"),{
sender:userId,
text:msgInput.value,
time:Date.now(),
readBy:{[userId]:true}
});
msgInput.value="";
};

/* ユーザー */
window.openUser=()=>{
show("userScreen");
userInfo.textContent="名前: "+localStorage.getItem("name");
myCode.textContent=localStorage.getItem("code");
};

/* フレンド追加 */
window.addFriend=async()=>{
const input=addCode.value.trim().toUpperCase();
const snap=await get(ref(db,"users"));
let target=null;
snap.forEach(u=>{if(u.val().code===input)target=u.key});
if(!target||target===userId)return alert("無効");
set(ref(db,`users/${userId}/friends/${target}`),true);
set(ref(db,`users/${target}/friends/${userId}`),true);
alert("追加完了");
};

/* 名前変更 */
window.changeName=()=>{
const n=newName.value.trim();
if(!n)return;
set(ref(db,"users/"+userId+"/name"),n);
localStorage.setItem("name",n);
alert("変更完了");
};

/* 初期化 */
window.resetAll=()=>{
if(confirm("初期化しますか？")){
localStorage.clear();
location.reload();
}
};

window.backHome=()=>loadHome();
</script>

</body>
</html>
