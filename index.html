<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>2Dアクションゲーム</title>
<style>
body { margin:0; background:black; }
canvas { display:block; margin:auto; background:#5c94fc; }
</style>
</head>
<body>

<canvas id="game" width="480" height="270"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

//================ 状態 =================
let scene = "title";
let language = "jp";
let control  = "button";

//================ 入力フラグ =================
let leftPressed = false;
let rightPressed = false;
let jumpPressed = false;

//================ テキスト =================
const TEXT = {
 jp:{
  title:"2Dアクションゲーム",
  play:"プレイ",
  goal:"ゴール！",
  back:"タイトルへ"
 }
};

//================ プレイヤー =================
const player = { x:50,y:0,w:24,h:24,vx:0,vy:0,onGround:false };
let cameraX = 0;

//================ ステージ =================
const platforms = [
 {x:0,y:240,w:2000,h:30},
 {x:200,y:190,w:80,h:10},
 {x:350,y:160,w:80,h:10},
 {x:520,y:180,w:80,h:10},
 {x:700,y:140,w:80,h:10}
];

// ゴール
const goal = { x:1850, y:190, w:20, h:50 };

const GRAVITY=0.6, SPEED=3, JUMP=-10;

//================ タッチ操作 =================
canvas.addEventListener("touchstart",e=>{
 const r=canvas.getBoundingClientRect();
 const x=e.touches[0].clientX-r.left;
 const y=e.touches[0].clientY-r.top;

 if(scene==="title"){
  if(x>140 && x<340 && y>170){
    reset(); scene="game";
  }
  return;
 }

 if(scene==="game"){
  // 左
  if(x<120 && y>200) leftPressed = true;
  // 右 ←★確実に右
  if(x>120 && x<240 && y>200) rightPressed = true;
  // ジャンプ
  if(x>360 && y>200) jumpPressed = true;
 }
});

canvas.addEventListener("touchend",()=>{
 leftPressed = false;
 rightPressed = false;
 jumpPressed = false;
});

//================ 処理 =================
function reset(){
 player.x=50; player.y=0;
 player.vx=0; player.vy=0;
 cameraX=0;
 scene="game";
}

function hit(a,b){
 return a.x<b.x+b.w && a.x+a.w>b.x &&
        a.y<b.y+b.h && a.y+a.h>b.y;
}

function update(){
 if(scene!=="game") return;

 // ボタン操作（確定）
 if(control==="button"){
  if(leftPressed) player.vx = -SPEED;
  else if(rightPressed) player.vx = SPEED;
  else player.vx = 0;

  if(jumpPressed && player.onGround){
    player.vy = JUMP;
    jumpPressed = false;
  }
 }

 player.vy += GRAVITY;
 player.x  += player.vx;
 player.y  += player.vy;
 player.onGround = false;

 platforms.forEach(p=>{
  if(hit(player,p) && player.vy>0){
   player.y = p.y - player.h;
   player.vy = 0;
   player.onGround = true;
  }
 });

 // カメラ
 cameraX = player.x - 200;
 if(cameraX < 0) cameraX = 0;

 // ゴール判定
 if(hit(player,goal)){
  scene = "goal";
 }

 if(player.y > canvas.height) reset();
}

//================ 描画 =================
function drawButton(x,y,w,h,text){
 ctx.fillStyle="#555";
 ctx.fillRect(x,y,w,h);
 ctx.strokeStyle="white";
 ctx.strokeRect(x,y,w,h);
 ctx.fillStyle="white";
 ctx.font="18px sans-serif";
 ctx.fillText(text,x+w/2-ctx.measureText(text).width/2,y+h/2+6);
}

function draw(){
 ctx.clearRect(0,0,480,270);

 if(scene==="title"){
  ctx.fillStyle="#5c94fc";
  ctx.fillRect(0,0,480,200);
  ctx.fillStyle="#228B22";
  ctx.fillRect(0,200,480,70);

  ctx.fillStyle="white";
  ctx.font="26px sans-serif";
  ctx.fillText(TEXT.jp.title,90,100);
  drawButton(140,170,200,40,"プレイ");
  return;
 }

 if(scene==="goal"){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,480,270);
  ctx.fillStyle="white";
  ctx.font="30px sans-serif";
  ctx.fillText(TEXT.jp.goal,170,120);
  ctx.font="18px sans-serif";
  ctx.fillText(TEXT.jp.back,190,170);
  return;
 }

 // ゲーム描画
 ctx.save();
 ctx.translate(-cameraX,0);

 // 地面
 ctx.fillStyle="#654321";
 platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

 // ゴール
 ctx.fillStyle="yellow";
 ctx.fillRect(goal.x,goal.y,goal.w,goal.h);

 // プレイヤー
 ctx.fillStyle="red";
 ctx.fillRect(player.x,player.y,player.w,player.h);

 ctx.restore();

 // 操作ボタン
 drawButton(20,210,40,40,"◀");
 drawButton(70,210,40,40,"▶");
 drawButton(400,210,50,40,"⬆");
}

//================ ループ =================
function loop(){
 update();
 draw();
 requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
