<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>リアルタイムグループチャット</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  background: #121212;
  color: white;
  font-family: sans-serif;
}
#messages {
  height: 80vh;
  overflow-y: auto;
  padding: 10px;
}
.msg {
  margin: 6px 0;
}
.system {
  color: #aaa;
  font-size: 14px;
}
#input {
  display: flex;
}
input {
  flex: 1;
  font-size: 16px;
}
button {
  font-size: 16px;
}
</style>
</head>
<body>

<div id="messages"></div>

<div id="input">
  <input id="name" placeholder="名前">
  <input id="text" placeholder="メッセージ">
  <button onclick="send()">送信</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCQNNj6Ff39wECAI6i8n1f2NXstF2k7duo",
  authDomain: "chat-99077.firebaseapp.com",
  databaseURL: "https://chat-99077-default-rtdb.firebaseio.com",
  projectId: "chat-99077",
  storageBucket: "chat-99077.firebasestorage.app",
  messagingSenderId: "991554319310",
  appId: "1:991554319310:web:a662919d90bc014e06319f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const chatRef = db.ref("chat");

let userName = localStorage.getItem("name") || "";

document.getElementById("name").value = userName;

if (userName) {
  system(`${userName} が入室しました`);
}

window.addEventListener("beforeunload", () => {
  if (userName) system(`${userName} が退出しました`);
});

function system(text) {
  chatRef.push({ system: true, text });
}

function send() {
  const nameInput = document.getElementById("name");
  const textInput = document.getElementById("text");

  userName = nameInput.value || "名無し";
  localStorage.setItem("name", userName);

  if (!textInput.value) return;

  chatRef.push({
    name: userName,
    text: textInput.value
  });

  textInput.value = "";
}

chatRef.on("child_added", snap => {
  const msg = snap.val();
  const div = document.createElement("div");

  if (msg.system) {
    div.className = "system";
    div.textContent = msg.text;
  } else {
    div.className = "msg";
    div.textContent = `${msg.name}: ${msg.text}`;
  }

  document.getElementById("messages").appendChild(div);
});
</script>

</body>
</html>
