<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Group Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #e5ddd5;
}
.screen {
  display: none;
  height: 100vh;
  padding: 20px;
}
.screen.active {
  display: block;
}
button {
  padding: 10px;
  font-size: 16px;
}
#messages {
  height: 80vh;
  overflow-y: auto;
}
.msg {
  max-width: 70%;
  padding: 8px 12px;
  margin: 6px;
  border-radius: 10px;
}
.me {
  background: #9fe6a0;
  margin-left: auto;
}
.other {
  background: white;
}
.system {
  text-align: center;
  color: #555;
  font-size: 13px;
}
</style>
</head>
<body>

<!-- 初期設定 -->
<div id="setup" class="screen">
  <h2>初期設定</h2>
  <input id="username" placeholder="ユーザー名"><br><br>
  <button onclick="saveUser()">保存</button>
</div>

<!-- グループ選択 -->
<div id="group" class="screen">
  <h2>グループ参加</h2>
  <input id="groupCode" placeholder="グループコード"><br><br>
  <button onclick="joinGroup()">参加</button>
</div>

<!-- チャット -->
<div id="chat" class="screen">
  <div id="messages"></div>
  <input id="text" placeholder="メッセージ">
  <button onclick="send()">送信</button>
</div>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyCQNNj6Ff39wECAI6i8n1f2NXstF2k7duo",
  authDomain: "chat-99077.firebaseapp.com",
  databaseURL: "https://chat-99077-default-rtdb.firebaseio.com",
  projectId: "chat-99077",
  storageBucket: "chat-99077.firebasestorage.app",
  messagingSenderId: "991554319310",
  appId: "1:991554319310:web:a662919d90bc014e06319f"
});

const db = firebase.database();
let user = localStorage.getItem("user");
let group = localStorage.getItem("group");

/* 画面制御 */
function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* 初期判定 */
if (!user) {
  show("setup");
} else if (!group) {
  show("group");
} else {
  startChat();
}

/* 初期設定 */
function saveUser() {
  const name = document.getElementById("username").value;
  if (!name) return;
  localStorage.setItem("user", name);
  user = name;
  show("group");
}

/* グループ参加 */
function joinGroup() {
  const code = document.getElementById("groupCode").value;
  if (!code) return;
  localStorage.setItem("group", code);
  group = code;
  startChat();
}

/* チャット開始 */
function startChat() {
  show("chat");
  const ref = db.ref("groups/" + group + "/messages");

  ref.on("child_added", snap => {
    const m = snap.val();
    const div = document.createElement("div");

    if (m.system) {
      div.className = "system";
      div.textContent = m.text;
    } else {
      div.className = "msg " + (m.user === user ? "me" : "other");
      div.textContent = m.user + ": " + m.text;
    }
    document.getElementById("messages").appendChild(div);
  });

  ref.push({ system: true, text: user + " が参加しました" });
}

/* 送信 */
function send() {
  const text = document.getElementById("text").value;
  if (!text) return;
  db.ref("groups/" + group + "/messages").push({
    user,
    text
  });
  document.getElementById("text").value = "";
}
</script>

</body>
</html>
